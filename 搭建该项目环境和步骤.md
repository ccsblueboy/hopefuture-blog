#Hope Future Blog 环境和搭建步骤

我们基于yeoman，用generator-angular生成器来搭建该项目，后端利用express开发，数据库基于mongodb。

版本说明：[generator-angular](https://github.com/yeoman/generator-angular) 的版本是 0.7.1 。
package.json 引入相关包的写法为："~x.x.x"，比如："grunt": "~0.4.4"，即表示搭建的时候grunt是基于0.4.1的，
后续可以用 `npm update` 升级相关包，但升级后不一定能保证程序的正常使用，这时我们就可以恢复到搭建时候的版本号了。bower.json 中的版本号也是如此。

注意：该项目是在window环境下搭建的，在安装 `npm install` 包时，由于网络原因，有时部分包可能会安装失败，如果发现那个包没有成功安装，
我们可以删除掉重新安装。当然也可以设置代理来安装，比如执行以下命令： `npm config set proxy=http://23.92.62.133:7808`


##创建项目目录

> md hopefuture-blog <br/>
> cd hopefuture-blog

##用express 初始化项目

首先我们需要安装 Node.js 。安装完后再安装 express（`npm install -g express`），成功后执行以下命令

> express --css less --ejs

--css less 表示利用less来管理css，--ejs表示利用ejs模板来渲染html

然后我们删除public和view文件夹，并创建server文件夹，把 routes 移到server下，修改app.js

```js
-var routes = require('./routes');
-var user = require('./routes/user');
+var routes = require('./server/routes');
+var user = require('./server/routes/user');
+var ejs = require('ejs');
....
-app.set('views', path.join(__dirname, 'views'));
-app.set('view engine', 'ejs');
//让ejs模板改为扩展名为html
+app.engine('.html', ejs.__express);
+app.set('view engine', 'html');
...
-app.use(require('less-middleware')({ src: path.join(__dirname, 'public') }));
+app.use(require('less-middleware')({ src: path.join(__dirname, 'app') }));
-app.use(express.static(path.join(__dirname, 'public')));
-if ('development' == app.get('env')) {
-  app.use(express.errorHandler());
-}
+if ('development' === app.get('env')) {
+  app.set('views', __dirname + '/app');
+  app.use(express.static(path.join(__dirname, 'app')));
+  app.use(express.errorHandler());
+} else {
+  app.set('views', __dirname);
+  app.use(express.static(path.join(__dirname, '')));
+}
...
+module.exports = app;
```

以上代码 `-` 表示删除的行，`+` 表示新加的行，下同。上面代码的修改，主要变动有
* 修改routes
* 让ejs模板改为扩展名为html，我们可以看[这里](http://expressjs.com/api.html#app.engine)
* 重新指定views路径以及express静态文件目录
* 添加module.exports = app;

执行 `npm install` 安装相关包

备份 package.json，防止用 yeoman 初始化的时候覆盖该文件

##用 yeoman 初始化项目

首先需要安装grunt、bower 和 yeoman以及angular生成器

> npm install -g grunt-cli <br/>
> npm install -g bower <br/>
> npm install -g yo <br/>
> npm install -g generator-angular <br/>

安装好后，我们利用 yo 来初始化angular，执行命令 `yo angular`
根据控制台提示信息来初始化angular框架，本人没有安装sass，打算使用less，其他的都选择了。
按提示完成操作后，系统会自动安装npm相关包以及bower包。

安装完后，我们需要合并一下package.json。
为了满足通过 `grunt server` 也能启动 express 运行，我们修改一下app下的index.html文件，加入 `<title><%= title %></title>`
并且修改 ./server/routes/index.js

```js
exports.index = function(req, res){
   -res.render('index', { title: 'Express' });
   +res.render('./index.html', { title: 'Express AngularJS app' });
 };
```

这时，我们执行 `grunt` 会提示 `Warning: Task "karma" not found. Use --force to continue.` 错误信息， 这是因为 generator-angular没有为我们安装
karma相关包，我们需要在 package.json 加上以下代码（别忘了加完后执行 `npm install`）

```
"karma": "^0.12.1", <br/>
"karma-chrome-launcher": "^0.1.2", <br/>
"karma-jasmine": "^0.1.5", <br/>
"grunt-karma": "^0.8.2" <br/>
```

安装好后，执行 `grunt` 一切正常，OK!

运行 `node app.js`，执行正常，现在变成了一个AngularJS app了，Good!

然后用grunt 运行 `grunt server` ，这时我们会发现页面title没有正确解析，这是因为grunt没有启动express服务，所以我们需要安装
`grunt express` task

##安装 grunt express 相关 task

我们在 https://www.npmjs.org 找到 `grunt express` task，这里我们选择
[grunt-express-server](https://www.npmjs.org/package/grunt-express-server)。
当然也可以选择[grunt-express](https://www.npmjs.org/package/grunt-express)，貌似grunt-express的功能更强大，但遗憾的是没有配置成功（以后待研究）。
grunt-express-server 是一个简单的利用grunt来启动express 的 task，支持 watch。
我们在package.json加入 `"grunt-express-server": "^0.4.13"` ，然后 `npm install`，
当然还需要修改 Gruntfile.js。因为 `grunt-express-server` task 是用来启动后台服务的，这与connect task 相冲突，故我们删除该 task，同时也删除package.json中的 `"grunt-contrib-concat": "~0.3.0",`
Gruntfile.js 要调整的代码如下：

```
...
watch: {
   ...
   livereload: {
     options: {
       livereload: '35729'
     },
     ...
   }
 },
 //删除connect task
 ...

 express: {
   options: {
     port: 9000
   },
   dev: {
     options: {
       script: './app.js'
     }
   }
 }
 ...

 grunt.registerTask('serve', function (target) {
   if (target === 'dist') {
     return grunt.task.run(['build']);
   }

   grunt.task.run([
     'clean:server',
     'bower-install',
     'concurrent:server',
     'autoprefixer',
     'express:dev',
     'watch'
   ]);
 });

 grunt.registerTask('server', function () {
   grunt.log.warn('The `server` task has been deprecated. Use `grunt serve` to start a server.');
   grunt.task.run(['serve']);
 });

 grunt.registerTask('test', [
   'clean:server',
   'concurrent:test',
   'autoprefixer',
   'karma'
 ]);

 grunt.registerTask('build', [
   'clean:dist',
   'bower-install',
   'useminPrepare',
   'concurrent:dist',
   'autoprefixer',
   'concat',
   'ngmin',
   'copy:dist',
   'cdnify',
   'cssmin',
   'uglify',
   'rev',
   'usemin',
   'htmlmin'
 ]);

 grunt.registerTask('default', [
   'newer:jshint',
   'test',
   'build'
 ]);
 ...
```

修改以上代码后，我们再执行 `grunt server` ，这时发现页面title能正确解析了，说明 express 启动了。但是还有个问题，就是不能 watch 后台代码，
我们试着修改 ./server/routes/index.js，然后刷新页面，发现页面并没有改变。

##watch express 后台代码

我们需要在watch task中加入监听 express 的代码，需要修改的代码如下

```
...
yeoman: {
  // configurable paths
  app: require('./bower.json').appPath || 'app',
  dist: 'dist',
  +server: 'server'
},
watch: {
  ...
  express: {
    files: ['app.js', '<%= yeoman.server %>/{,*/}*.js' ],
    tasks: [ 'express:dev' ],
    options: {
      spawn: false
    }
  }
},
```

加好后，我们用 `grunt server` 启动服务，再修改 ./server/routes/index.js，这时会发现控制台会输出以下信息

```
OK
>> File "server\routes\index.js" changed.
Running "express:dev" (express) task
Stopping Express server
Starting background Express server
Running "watch" task
Completed in 0.077s at Tue Mar 25 2014 16:55:08 GMT+0800 (中国标准时间) - Waiting...
Express server listening on port 9000
```

说明 express 服务重启了

##把 express 代码加入到 grunt 任务中
首先创建build所需的package.json，我们创建文件夹 publish，在该文件夹下加入package.json。该文件中需要引入相关依赖包。
```
...
"dependencies": {
    "express": "~3.4.8",
    "ejs": "~1.0.0",
    "less-middleware": "0.1.15"
  },
 ...
```
修改文件Gruntfile.js

加入全局变量 publish
```
 yeoman:
    ...
    publish: 'publish'
},
```
在 `jshint` 任务中加入以下代码
```
jshint: {
      ...
      all: [
        'Gruntfile.js',
        '<%= yeoman.app %>/scripts/{,*/}*.js',
        + '<%= yeoman.server %>/{,*/}*.js'
      ],
     ...
    },
```
在 `copy` 任务中加入以下代码

 ``` json
copy: {
      dist: {
        files: [
          ...
          {
            expand: true,
            cwd: './',
            dest: '<%= yeoman.dist %>',
            src: ['<%= yeoman.server %>/**']
          },
          {
            expand: true,
            cwd: './',
            dest: '<%= yeoman.dist %>',
            src: ['app.js']
          },
          {
            expand: true,
            cwd: '<%= yeoman.publish %>',
            dest: '<%= yeoman.dist %>',
            src: ['**']
          }
        ]
      },
      ...
    },
```

##重新调整文件夹app build后路径结构
这里主要修改 Gruntfile.js文件

加入变量 webapp
```
yeoman: {
  ...
  webapp: 'dist/webapp'
},
```
调整 `<%= yeoman.dist %>` 为 `<%= yeoman.webapp %>`
修改的 task 有：imagemin、svgmin、copy、useminPrepare

同时修改 app.js

```
if ('development' === app.get('env')) {
  ...
} else {
  app.set('views', __dirname + '/webapp');
  app.use(express.static(path.join(__dirname, 'webapp')));
}
```
## 学习 grunt 相关任务

### load-grunt-tasks
自动加载 grunt tasks
官网： https://github.com/sindresorhus/load-grunt-tasks
npm 网：https://www.npmjs.org/package/load-grunt-tasks
只需加入以下代码即可加载所有grunt开头的tasks
```
require('load-grunt-tasks')(grunt);
```
我们还可以加入options来设置过滤条件，比如
```
require('load-grunt-tasks')(grunt, {
    pattern: 'grunt-contrib-*',
    config: '../package.json',
    scope: 'devDependencies'
});
```
如果不设置options，默认值为：
**pattern**

Type: String|Array
Default: 'grunt-*'

**config**

Type: String|Object
Default: Path to nearest package.json

**scope**

Type: String|Array
Default: ['dependencies', 'devDependencies', 'peerDependencies']

### time-grunt
统计显示各任务执行的时间

官网： https://github.com/sindresorhus/time-grunt

npm 网：https://www.npmjs.org/package/time-grunt

用法
```
require('time-grunt')(grunt);
```

### grunt-contrib-watch
watch 任务是用来检测任何你所指定的文件发生变化时，按照你所指定的顺序执行指定的任务。
这样就会在grunt服务启动的时候，修改文件后会自动执行任务，从而不用频繁重启服务，方便开发。

官网： https://github.com/gruntjs/grunt-contrib-watch

npm 网：https://www.npmjs.org/package/grunt-contrib-watch

### grunt-contrib-jshint
该任务是基于 JSHint 用来检测 javascript 代码的，他可以发现代码错误、查找代码潜在的问题以及不规范的写法。
通过定制JSHint配置文件，可以使团队按照俗称的规范来开发项目。

官网： https://github.com/gruntjs/grunt-contrib-watch

npm 网：https://www.npmjs.org/package/grunt-contrib-jshint

检验规则例子： http://jslinterrors.com/

### grunt-contrib-clean
该任务用来清空文件夹和文件，当编译或运行前清理

官网： https://github.com/gruntjs/grunt-contrib-clean

npm 网：https://www.npmjs.org/package/grunt-contrib-clean

### grunt-autoprefixer
该任务用来分析css并为css3加上各浏览器前缀

官网： https://github.com/nDmitry/grunt-autoprefixer

npm 网：https://www.npmjs.org/package/grunt-autoprefixer

## 整合 mongodb 数据库
我们采用 [Mongoose](http://mongoosejs.com/) 来操作 [MongoDB](http://www.mongodb.org/)

##总结

yeoman构建angular项目生成器 `generator-angular` 的官网为

```
git://github.com/yeoman/generator-angular.git
https://github.com/yeoman/generator-angular
```

该 generator 除了可以生成项目基本框架，还可以创建controller service directive等，详细见官网说明。

项目中也可以用 `grunt-express` （待研究替换）来启动 express，官方有基于 generator-angular 和 express 的简单例子

```
https://github.com/blai/grunt-express
https://github.com/blai/grunt-express-angular-example
```

##参考资料

关于用yo构建AngularJS可以参考
```
http://owenchen.duapp.com/index.php/yeo-angular/
```

karma 相关信息可以看这里

```
http://karma-runner.github.io/
http://karma-runner.github.io/0.12/intro/installation.html
http://karma-runner.github.io/0.10/intro/configuration.html
```
