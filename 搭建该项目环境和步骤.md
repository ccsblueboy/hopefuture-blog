#Hope Future Blog 环境和搭建步骤

我们基于yeoman，用generator-angular生成器来搭建该项目，后端利用express开发，数据库基于mongodb。

版本说明：[generator-angular](https://github.com/yeoman/generator-angular) 的版本是 0.7.1 。
package.json 引入相关包的写法为："~x.x.x"，比如："grunt": "~0.4.4"，即表示搭建的时候grunt是基于0.4.1的，
后续可以用 `npm update` 升级相关包，但升级后不一定能保证程序的正常使用，这时我们就可以恢复到搭建时候的版本号了。bower.json 中的版本号也是如此。

注意：该项目是在window环境下搭建的，在安装 `npm install` 包时，由于网络原因，有时部分包可能会安装失败，如果发现那个包没有成功安装，
我们可以删除掉重新安装。当然也可以设置代理来安装，比如执行以下命令： `npm config set proxy=http://23.92.62.133:7808`


##创建项目目录

> md hopefuture-blog <br/>
> cd hopefuture-blog

##用express 初始化项目

首先我们需要安装 Node.js 。安装完后再安装 express（`npm install -g express`），成功后执行以下命令

> express --css less --ejs

--css less 表示利用less来管理css，--ejs表示利用ejs模板来渲染html

然后我们删除public和view文件夹，并创建server文件夹，把 routes 移到server下，修改app.js

```js
-var routes = require('./routes');
-var user = require('./routes/user');
+var routes = require('./server/routes');
+var user = require('./server/routes/user');
+var ejs = require('ejs');
....
-app.set('views', path.join(__dirname, 'views'));
-app.set('view engine', 'ejs');
//让ejs模板改为扩展名为html
+app.engine('.html', ejs.__express);
+app.set('view engine', 'html');
...
-app.use(require('less-middleware')({ src: path.join(__dirname, 'public') }));
+app.use(require('less-middleware')({ src: path.join(__dirname, 'app') }));
-app.use(express.static(path.join(__dirname, 'public')));
-if ('development' == app.get('env')) {
-  app.use(express.errorHandler());
-}
+if ('development' === app.get('env')) {
+  app.set('views', __dirname + '/app');
+  app.use(express.static(path.join(__dirname, 'app')));
+  app.use(express.errorHandler());
+} else {
+  app.set('views', __dirname);
+  app.use(express.static(path.join(__dirname, '')));
+}
...
+module.exports = app;
```

以上代码 `-` 表示删除的行，`+` 表示新加的行，下同。上面代码的修改，主要变动有
* 修改routes
* 让ejs模板改为扩展名为html，我们可以看[这里](http://expressjs.com/api.html#app.engine)
* 重新指定views路径以及express静态文件目录
* 添加module.exports = app;

执行 `npm install` 安装相关包

备份 package.json，防止用 yeoman 初始化的时候覆盖该文件

##用 yeoman 初始化项目

首先需要安装grunt、bower 和 yeoman以及angular生成器

> npm install -g grunt-cli <br/>
> npm install -g bower <br/>
> npm install -g yo <br/>
> npm install -g generator-angular <br/>

安装好后，我们利用 yo 来初始化angular，执行命令 `yo angular`
根据控制台提示信息来初始化angular框架，本人没有安装sass，打算使用less，其他的都选择了。
按提示完成操作后，系统会自动安装npm相关包以及bower包。

安装完后，我们需要合并一下package.json。
为了满足通过 `grunt server` 也能启动 express 运行，我们修改一下app下的index.html文件，加入 `<title><%= title %></title>`
并且修改 ./server/routes/index.js

```js
exports.index = function(req, res){
   -res.render('index', { title: 'Express' });
   +res.render('./index.html', { title: 'Express AngularJS app' });
 };
```

这时，我们执行 `grunt` 会提示 `Warning: Task "karma" not found. Use --force to continue.` 错误信息， 这是因为 generator-angular没有为我们安装
karma相关包，我们需要在 package.json 加上以下代码（别忘了加完后执行 `npm install`）

```
"karma": "^0.12.1", <br/>
"karma-chrome-launcher": "^0.1.2", <br/>
"karma-jasmine": "^0.1.5", <br/>
"grunt-karma": "^0.8.2" <br/>
```

安装好后，执行 `grunt` 一切正常，OK!

运行 `node app.js`，执行正常，现在变成了一个AngularJS app了，Good!

然后用grunt 运行 `grunt server` ，这时我们会发现页面title没有正确解析，这是因为grunt没有启动express服务，所以我们需要安装
`grunt express` task

##安装 grunt express 相关 task

我们在 https://www.npmjs.org 找到 `grunt express` task，这里我们选择
[grunt-express-server](https://www.npmjs.org/package/grunt-express-server)。
当然也可以选择[grunt-express](https://www.npmjs.org/package/grunt-express)，貌似grunt-express的功能更强大，但遗憾的是没有配置成功（以后待研究）。
grunt-express-server 是一个简单的利用grunt来启动express 的 task，支持 watch。
我们在package.json加入 `"grunt-express-server": "^0.4.13"` ，然后 `npm install`，
当然还需要修改 Gruntfile.js。因为 `grunt-express-server` task 是用来启动后台服务的，这与connect task 相冲突，故我们删除该 task，同时也删除package.json中的 `"grunt-contrib-concat": "~0.3.0",`
Gruntfile.js 要调整的代码如下：

```
...
watch: {
   ...
   livereload: {
     options: {
       livereload: '35729'
     },
     ...
   }
 },
 //删除connect task
 ...

 express: {
   options: {
     port: 9000
   },
   dev: {
     options: {
       script: './app.js'
     }
   }
 }
 ...

 grunt.registerTask('serve', function (target) {
   if (target === 'dist') {
     return grunt.task.run(['build']);
   }

   grunt.task.run([
     'clean:server',
     'bowerInstall',
     'concurrent:server',
     'autoprefixer',
     'express:dev',
     'watch'
   ]);
 });

 grunt.registerTask('server', function () {
   grunt.log.warn('The `server` task has been deprecated. Use `grunt serve` to start a server.');
   grunt.task.run(['serve']);
 });

 grunt.registerTask('test', [
   'clean:server',
   'concurrent:test',
   'autoprefixer',
   'karma'
 ]);

 grunt.registerTask('build', [
   'clean:dist',
   'bowerInstall',
   'useminPrepare',
   'concurrent:dist',
   'autoprefixer',
   'concat',
   'ngmin',
   'copy:dist',
   'cdnify',
   'cssmin',
   'uglify',
   'rev',
   'usemin',
   'htmlmin'
 ]);

 grunt.registerTask('default', [
   'newer:jshint',
   'test',
   'build'
 ]);
 ...
```

修改以上代码后，我们再执行 `grunt server` ，这时发现页面title能正确解析了，说明 express 启动了。但是还有个问题，就是不能 watch 后台代码，
我们试着修改 ./server/routes/index.js，然后刷新页面，发现页面并没有改变。

##watch express 后台代码

我们需要在watch task中加入监听 express 的代码，需要修改的代码如下

```
...
yeoman: {
  // configurable paths
  app: require('./bower.json').appPath || 'app',
  dist: 'dist',
  +server: 'server'
},
watch: {
  ...
  express: {
    files: ['app.js', '<%= yeoman.server %>/{,*/}*.js' ],
    tasks: [ 'express:dev' ],
    options: {
      spawn: false
    }
  }
},
```

加好后，我们用 `grunt server` 启动服务，再修改 ./server/routes/index.js，这时会发现控制台会输出以下信息

```
OK
>> File "server\routes\index.js" changed.
Running "express:dev" (express) task
Stopping Express server
Starting background Express server
Running "watch" task
Completed in 0.077s at Tue Mar 25 2014 16:55:08 GMT+0800 (中国标准时间) - Waiting...
Express server listening on port 9000
```

说明 express 服务重启了

##把 express 代码加入到 grunt 任务中
首先创建build所需的package.json，我们创建文件夹 publish，在该文件夹下加入package.json。该文件中需要引入相关依赖包。
```
...
"dependencies": {
    "express": "~3.4.8",
    "ejs": "~1.0.0",
    "less-middleware": "0.1.15"
  },
 ...
```
修改文件Gruntfile.js

加入全局变量 publish
```
 yeoman:
    ...
    publish: 'publish'
},
```
在 `jshint` 任务中加入以下代码
```
jshint: {
      ...
      all: [
        'Gruntfile.js',
        '<%= yeoman.app %>/scripts/{,*/}*.js',
        + '<%= yeoman.server %>/{,*/}*.js'
      ],
     ...
    },
```
在 `copy` 任务中加入以下代码

 ``` json
copy: {
      dist: {
        files: [
          ...
          {
            expand: true,
            cwd: './',
            dest: '<%= yeoman.dist %>',
            src: ['<%= yeoman.server %>/**']
          },
          {
            expand: true,
            cwd: './',
            dest: '<%= yeoman.dist %>',
            src: ['app.js']
          },
          {
            expand: true,
            cwd: '<%= yeoman.publish %>',
            dest: '<%= yeoman.dist %>',
            src: ['**']
          }
        ]
      },
      ...
    },
```

##重新调整文件夹app build后路径结构
这里主要修改 Gruntfile.js文件

加入变量 webapp
```
yeoman: {
  ...
  webapp: 'dist/webapp'
},
```
调整 `<%= yeoman.dist %>` 为 `<%= yeoman.webapp %>`
修改的 task 有：imagemin、svgmin、htmlmin、copy、useminPrepare,、rev、usemin

同时修改 app.js

```
if ('development' === app.get('env')) {
  ...
} else {
  app.set('views', __dirname + '/webapp');
  app.use(express.static(path.join(__dirname, 'webapp')));
}
```
## 学习 grunt 相关任务

### load-grunt-tasks
自动加载 grunt tasks

官网： https://github.com/sindresorhus/load-grunt-tasks

npm 网：https://www.npmjs.org/package/load-grunt-tasks

只需加入以下代码即可加载所有grunt开头的tasks
```
require('load-grunt-tasks')(grunt);
```
我们还可以加入options来设置过滤条件，比如
```
require('load-grunt-tasks')(grunt, {
    pattern: 'grunt-contrib-*',
    config: '../package.json',
    scope: 'devDependencies'
});
```
如果不设置options，默认值为：
**pattern**

Type: String|Array
Default: 'grunt-*'

**config**

Type: String|Object
Default: Path to nearest package.json

**scope**

Type: String|Array
Default: ['dependencies', 'devDependencies', 'peerDependencies']

### time-grunt
统计显示各任务执行的时间

官网： https://github.com/sindresorhus/time-grunt

npm 网：https://www.npmjs.org/package/time-grunt

用法
```
require('time-grunt')(grunt);
```

### grunt-contrib-watch
watch 任务是用来检测任何你所指定的文件发生变化时，按照你所指定的顺序执行指定的任务。
这样就会在grunt服务启动的时候，修改文件后会自动执行任务，从而不用频繁重启服务，方便开发。

官网： https://github.com/gruntjs/grunt-contrib-watch

npm 网：https://www.npmjs.org/package/grunt-contrib-watch

### grunt-contrib-jshint
该任务是基于 JSHint 用来检测 javascript 代码的，他可以发现代码错误、查找代码潜在的问题以及不规范的写法。
通过定制JSHint配置文件，可以使团队按照俗称的规范来开发项目。

官网： https://github.com/gruntjs/grunt-contrib-watch

npm 网：https://www.npmjs.org/package/grunt-contrib-jshint

检验规则例子： http://jslinterrors.com/

### grunt-contrib-clean
该任务用来清空文件夹和文件，当编译或运行前清理

官网： https://github.com/gruntjs/grunt-contrib-clean

npm 网：https://www.npmjs.org/package/grunt-contrib-clean

### grunt-autoprefixer
该任务用来分析css并为css3加上各浏览器前缀

官网： https://github.com/nDmitry/grunt-autoprefixer

npm 网：https://www.npmjs.org/package/grunt-autoprefixer

关于css检测和自动生成代码，可以参看这里 https://github.com/ai/autoprefixer。对于带前缀的 css 属性，可以参见 http://caniuse.com/

### grunt-bower-install
该任务用来自动把 bower.json 配置的前端包注入到html页面中

官网： http://stephenplusplus.github.io/grunt-bower-install

npm 网：https://www.npmjs.org/package/grunt-bower-install

基于 yo angular 生成器，该任务的版本是0.7.0，项目中已经升级到最新版本。任务名也由 bower-install 变成 bowerInstall
可以在html jade scss yml 等文件中加入以下代码
```
<!-- For JavaScript dependencies -->
<!-- bower:js -->
<!-- endbower -->

<!-- For css dependencies -->
<!-- bower:css -->
<!-- endbower -->
```

### grunt-rev
该任务用来重新命名文件，新的文件名是基于以下选项设置的，默认值分别为 md5 和 8。这个任务和 [yeoman/grunt-usemin](https://github.com/yeoman/grunt-usemin) 一起使用
```
options: {
  algorithm: 'md5', // 可以是 'sha1', 'md5', 'sha256', 'sha512', etc.
  length: 8
}
```
例如： app.js 会被重新命名为 9becff3a.app.js

官网： https://github.com/cbas/grunt-rev

npm 网：https://www.npmjs.org/package/grunt-rev

### grunt-usemin
该任务是用来压缩优化js和css代码的，包含了两个不同的任务 useminPrepare 和 usemin，前者会启用 concat、uglify、cssmin 来处理转换文件，
后者根据useminPrepare处理的文件来替换相关文件。该任务主要用在打包 build 发布阶段。

官网： https://github.com/yeoman/grunt-usemin

npm 网：https://www.npmjs.org/package/grunt-usemin

#### useminPrepare 任务
需要在html等页面中配置以下代码
```
<!-- build:<type>(alternate search path) <path> -->
... HTML Markup, list of script / link tags.
<!-- endbuild -->
```
1.  **type**: either js or css
2.  **alternate** search path: (optional) By default the input files are relative to the treated file. Alternate search path allows one to change that
3.  **path**: the file path of the optimized file, the target output

By default the flow is: concat -> uglifyjs.

例子
```
<!-- build:js js/app.js -->
<script src="js/app.js"></script>
<script src="js/controllers/thing-controller.js"></script>
<script src="js/models/thing-model.js"></script>
<script src="js/views/thing-view.js"></script>
<!-- endbuild -->
```
首先用 concat 合并这四个文件（合并后的文件为js/app.js），然后用 uglifyjs 压缩合并后的文件，最后输出到dist目录下。
这个过程相当于
```
{
  concat: {
    '.tmp/concat/js/app.js': [
      'app/js/app.js',
      'app/js/controllers/thing-controller.js',
      'app/js/models/thing-model.js',
      'app/js/views/thing-view.js'
      ]
  },
  uglifyjs: {
    'dist/js/app.js': ['.tmp/concat/js/app.js']
  }
}
```
上面的任务只会生成相应配置选项，如果要转换文件还得需要 usemin 等任务

#### usemin 任务
用重新命名的压缩文件替换 html 中指定形如以下块的地方
```
<!-- build:<type>(alternate search path) <path> -->
... HTML Markup, list of script / link tags.
<!-- endbuild -->
```
例如: file dist/html/index.html has the following content
```
<link rel="stylesheet" href="styles/main.css">
<img src="../images/test.png">
```
* styles/main.css: 会在 dist/html/styles 目录下查找形如 1234.main.css 的文件来替换
* ../images/test.png： 会在目录 dist/images 下查找替换

以上例子是给的相对目录，还可以是绝对目录，详见官网说明

### grunt-contrib-imagemin
处理压缩 PNG, JPEG and GIF images

官网： https://github.com/gruntjs/grunt-contrib-imagemin

npm 网：https://www.npmjs.org/package/grunt-contrib-imagemin

### grunt-svgmin
处理压缩 svg格式的文件

官网： https://github.com/sindresorhus/grunt-svgmin

npm 网：https://www.npmjs.org/package/grunt-svgmin

### grunt-contrib-htmlmin
处理压缩html文件，根据配置项删除不必要的代码(包括空格和换行)

官网： https://github.com/gruntjs/grunt-contrib-htmlmin

npm 网：https://www.npmjs.org/package/grunt-contrib-htmlmin

### grunt-ngmin

用来处理 Angular 代码中不安全的注入方式，在压缩的时候 grunt-ngmin会处理的，该任务需要放在uglify之前执行

官网： https://github.com/gruntjs/grunt-contrib-htmlmin

npm 网：https://www.npmjs.org/package/grunt-ngmin

### grunt-google-cdn
用本地资源替换 the Google CDN 的资源

### grunt-contrib-copy

用来copy文件，build 打包的时候把源代码复制到 dist 目录下

官网： https://github.com/gruntjs/grunt-contrib-copy

npm 网：https://www.npmjs.org/package/grunt-contrib-copy

### grunt-concurrent
用来指定多个 grunt tasks，这样就可以归类 tasks，便于管理

官网： https://github.com/sindresorhus/grunt-concurrent

npm 网：https://www.npmjs.org/package/grunt-concurrent

### grunt-karma
单元测试 task，一般会根据配置选项 configFile 设置的内容进行测试，可以使用 jasmine/mocha/qunit 等来测试，需要依赖
```
"karma": "^0.12.1",
"karma-chrome-launcher": "^0.1.2",
"karma-jasmine": "^0.1.5",
```
官网： https://github.com/karma-runner/grunt-karma

npm 网：https://www.npmjs.org/package/grunt-karma

### grunt-express-server
上面已介绍过

### grunt-newer
用来新创建一个任务，创建的任务只要文件被修改了，才会启动，用 `newer:taskName` 调用
```
grunt.initConfig({
    uglify: {
      all: {
        files: {
          'dest/app.min.js': ['src/**/*.js']
        }
      }
    }
  });

  grunt.loadNpmTasks('grunt-contrib-uglify');
  grunt.loadNpmTasks('grunt-newer');

  grunt.registerTask('minify', ['newer:uglify:all']);
```
上面代码只有 src/**/*.js 更新了，才会触发任务 uglify:all

官网： https://github.com/tschaub/grunt-newer

npm 网：https://www.npmjs.org/package/grunt-newer

## 整合 mongodb 数据库
我们采用 [Mongoose](http://mongoosejs.com/) 来操作 [MongoDB](http://www.mongodb.org/)

## 加入 Angular UI Bootstrap
[Angular UI Bootstrap](https://github.com/angular-ui/bootstrap) 是基于 Bootstrap 开发的一套UI组件，我们使用最新版（基于bootstrap 3）。

在 bower 中引入 `angular-bootstrap`，这里需要注意的是不能引入 `angular-ui-bootstrap`，后者是源代码，前者是编译后的代码。
angular module 需要加入该依赖 `angular.module('myModule', ['ui.bootstrap']);`

## 项目例子

1. 分页显示例子，url相对路径为 example-pagination/
2. 基本Grid 列表，url相对路径为 example-grid/

## Grunt Task 扩展

### grunt-contrib-less
官网： https://github.com/gruntjs/grunt-contrib-less

npm 网：https://www.npmjs.org/package/grunt-contrib-less

该任务可以把less文件编译成css

### grunt-jsdoc

官网： https://github.com/krampstudio/grunt-jsdoc

npm 网：https://www.npmjs.org/package/grunt-jsdoc

该任务可以作为 javascript API 生成器。执行命令 `npm install grunt-jsdoc --save-dev` 来安装该任务。
同时还需要全局安装 jsdoc `npm install -g jsdoc`。

下面给出一例子
```
jsdoc: {
      examples: {
        src: ['examples/jsdoc/src/*.js'],
        options: {
          destination: 'examples/jsdoc/doc'
        }
      }
    }
```
jsdoc 默认的模板不是很好看，我们可以定制自己的模板主题。这里选用第三方提供的模板主题，主要有以下

1. [jaguarjs-jsdoc](https://github.com/davidshimjs/jaguarjs-jsdoc) ([example](http://davidshimjs.github.io/jaguarjs/doc))
2. [DocStrap](https://github.com/terryweiss/docstrap)
3. [jsdoc3Template](https://github.com/DBCDK/jsdoc3Template) ([example](https://github.com/danyg/jsdoc3Template/wiki#wiki-screenshots))

#### DocStrap
DocStrap 是基于bootstrap（2.3.1）生的的一个jsdoc模板，在讲解 DocStrap 的时候，我们顺便把 jsdoc 怎样使用简单的介绍一下。

首先安装jsdoc `npm install -g jsdoc` ，然后安装 DocStrap 模板 `npm install ink-docstrap` ，该模板中包含了13个theme，我们可以通过修改 `jsdoc.conf.json`
中的 theme 来设置你想要的主题。设置好后，我们就可以执行以下命令来生成 jsdoc 了

`jsdoc mysourcefiles/* -t <path.to.unzipped>/template -c <path.to.unzipped>/conf.json  <path.to.output>/`

假如要生成jsdoc的目录为 `D:\jsdoc-examples` ，目录中src是js源文件，文件夹 `ink-docstrap` 是 jsdoc模板，我们就可以执行以下命令

`jsdoc src/* -t ink-docstrap/template -c ink-docstrap/jsdoc.conf.json  out/`

当然我们也可以定制 docstrap，比如我们想替换成基于 bootstrap 3。首先下载[模板源文件](https://github.com/terryweiss/docstrap/archive/master.zip)。
下载并解压后，执行以下命令

```
bower install
npm install
```
注意bower中bootstrap默认为2.3.1，我们可以修改为3.x.x. 。然后修改相关源文件，修改好后，执行以下命令生成jsdoc模板

```
grunt less
grunt apply
```
也可以在 jsdoc.conf.json 中设置其他主题（theme），当然可以执行build 任务来重新生成jsdoc 模板。

上面的讲解是在命令行中执行，下面简单的说一下利用grunt来自动生成，grunt-jsdoc 的任务定制代码如下：

```
jsdoc: {
      examples: {
        src: ['examples/jsdoc/src/*.js'],
        options: {
          destination: 'examples/jsdoc/doc',
          template: 'jsdoc-templetes/ink-docstrap/template',//模板路径
          configure: 'jsdoc-templetes/ink-docstrap/template/jsdoc.conf.json'//conf.json
        }
      }
    }
```
运行以上任务即可完成jsdoc的生成

#### jaguarjs-jsdoc
首先到这里下载模板 https://github.com/davidshimjs/jaguarjs-jsdoc，该模板中提供了一些例子。该模板的实现源码参见官网
http://davidshimjs.github.io/jaguarjs/
该模板指南可以看这里： http://davidshimjs.github.io/jaguarjs/doc/（我们也可以参考这个来写自己的博客，待研究）

#### jsdoc3Template
该模板本地运行有错误，待研究。官方例子提供的皮肤类似于javadoc样子

##总结

yeoman构建angular项目生成器 `generator-angular` 的官网为

```
git://github.com/yeoman/generator-angular.git
https://github.com/yeoman/generator-angular
```

该 generator 除了可以生成项目基本框架，还可以创建controller service directive等，详细见官网说明。

项目中也可以用 `grunt-express` （待研究替换）来启动 express，官方有基于 generator-angular 和 express 的简单例子

```
https://github.com/blai/grunt-express
https://github.com/blai/grunt-express-angular-example
```

##参考资料

关于用yo构建AngularJS可以参考
```
http://owenchen.duapp.com/index.php/yeo-angular/
```

karma 相关信息可以看这里

```
http://karma-runner.github.io/
http://karma-runner.github.io/0.12/intro/installation.html
http://karma-runner.github.io/0.10/intro/configuration.html
```
